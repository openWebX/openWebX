var PBB_MagicWheel=new Class({Implements:[Events,Options],options:{maxWidth:0.9,minWidth:100,maxHeight:0.2,minHeight:10,iconMaxWidth:128,iconMinWidth:0,iconMinOpacity:0,gradReflection:0.7,userIconWidth:64,userIconMinWidth:30,userWidth:null,userHeight:5,userSpeed:0.05,userIconOpacity:1,userIconMinOpacity:0.3,userRefOpacity:0.7},initialize:function(b,a){this.setOptions(a);this.magicwheel=b;this.screenSize=window.getSize();this.icons=this.magicwheel.getElements(".icon");this.counter=1;this.speed=0.1;this.iconover=false;this.tip=new Element("span",{"class":"tip"}).inject(document.body);new Element("span").inject(this.tip);if(this.options.maxWidth<=1){this.options.maxWidth=this.screenSize.x*this.options.maxWidth}if(this.options.minWidth<=1){this.options.minWidth=this.screenSize.x*this.options.minWidth}if(this.options.maxHeight<=1){this.options.maxHeight=this.screenSize.y*this.options.maxHeight}if(this.options.minHeight<=1){this.options.minHeight=this.screenSize.y*this.options.minHeight}var c=this.icons.length*this.options.userIconWidth*0.45;this.options.userWidth=(c<this.options.maxWidth)?c:this.options.maxWidth;this.checkSettings();this.magicwheel.addEvent("mousewheel",function(g){g.stop();if(!this.iconover){this.speed=g.wheel>0?(this.speed-0.5):(this.speed+0.5)}else{var f=360/this.icons.length/57.3;this.counter=g.wheel>0?(this.counter-f):(this.counter+f);this.run(true)}}.bind(this));var d=[];this.icons.each(function(e){if(e.get("src")){d.include(e.get("src"))}});new Asset.images(d,{onProgress:function(e){}.bind(this),onComplete:function(){this.build()}.bind(this)})},build:function(){this.icons.each(function(a){var b=a.getParent().get("href");a.set("id","icon-"+b);this.addIconEvent(a);this.addIconReflection(a)},this);this.magicwheel.removeClass("loading");this.run.periodical(50,this)},addIcon:function(c,b,d){this.magicwheel.addClass("loading");var e=new Element("a",{title:d,href:c});var a=new Element("img",{id:"icon-"+c,"class":"icon",src:b}).inject(e.inject(this.magicwheel));new Asset.image(b,{onload:function(){this.addIconEvent(a);this.icons=this.magicwheel.getElements(".icon");this.addIconReflection(a);this.magicwheel.removeClass("loading")}.bind(this,a)})},addIconEvent:function(a){var b=a.retrieve("tip:title",a.getParent().get("title"));if(!b){b=a.retrieve("tip:title",a.getParent().get("href"))}a.getParent().erase("title");a.addEvent("mouseover",function(e){this.iconover=true;this.tip.getFirst().set("text",e.retrieve("tip:title"));var c=e.getCoordinates();var d=this.tip.getSize();this.tip.setStyles({left:c.left-d.x/2+c.width/2,top:c.top-d.y-2,opacity:0.7})}.bind(this,a)).addEvent("mouseout",function(c){this.tip.setStyle("visibility","hidden");this.iconover=false}.bind(this))},addIconReflection:function(c){if(this.options.gradReflection>0){if(Browser.Engine.trident){var d=c.clone();new Element("div").setStyles({width:d.width,height:d.height}).addClass("ref").adopt(d).inject(this.magicwheel);d.setStyles({filter:"flipv progid:DXImageTransform.Microsoft.Alpha(opacity="+(this.options.gradReflection*100)+", style=1, finishOpacity=0, startx=0, starty=0, finishx=0, finishy="+(this.options.gradReflection*100)+")",width:"100%",height:"100%"})}else{var b=c.getSize();var f=new Element("canvas",{styles:{width:b.x,height:b.y}});if(f.getContext){var a=f.setProperties({width:b.x,height:b.y}).getContext("2d");a.save();a.translate(0,b.y-1);a.scale(1,-1);a.drawImage(c,0,0,b.x,b.y);a.restore();a.globalCompositeOperation="destination-out";var e=a.createLinearGradient(0,0,0,b.y);e.addColorStop(0,"rgba(255, 255, 255, "+(1-this.options.gradReflection)+")");e.addColorStop(1,"rgba(255, 255, 255, 1.0)");a.fillStyle=e;a.rect(0,0,b.x,b.y);a.fill()}f.addClass("ref").inject(this.magicwheel)}this.reflections=this.magicwheel.getElements(".ref")}},checkSettings:function(){if(this.options.userIconWidth>this.options.iconMaxWidth){this.options.userIconWidth=this.options.iconMaxWidth}if(this.options.userIconWidth<this.options.iconMinWidth){this.options.userIconWidth=this.options.iconMinWidth}if(this.options.userIconMinWidth>this.options.userIconWidth){this.options.userIconMinWidth=this.options.userIconWidth}if(this.options.userIconMinWidth<this.options.iconMinWidth){this.options.userIconMinWidth=this.options.iconMinWidth}if(this.options.userWidth>this.options.maxWidth-this.options.userIconWidth){this.options.userWidth=this.options.maxWidth-this.options.userIconWidth}if(this.options.userWidth<this.options.minWidth){this.options.userWidth=this.options.minWidth}if(this.options.userHeight*this.icons.length>this.options.maxHeight){this.options.userHeight=this.options.maxHeight/this.icons.length}if(this.options.userHeight*this.icons.length<this.options.minHeight){this.options.userHeight=this.options.minHeight/this.icons.length}if(this.options.userSpeed>1){this.options.userSpeed=1}if(this.options.userSpeed<-1){this.options.userSpeed=-1}if(this.options.userIconOpacity>1){this.options.userIconOpacity=1}if(this.options.userIconOpacity<this.options.iconMinOpacity){this.options.userIconOpacity=this.options.iconMinOpacity}if(this.options.userIconMinOpacity>this.options.userIconOpacity){this.options.userIconMinOpacity=this.options.userIconOpacity}if(this.options.userIconMinOpacity<this.options.iconMinOpacity){this.options.userIconMinOpacity=this.options.iconMinOpacity}if(this.options.userRefOpacity>1){this.options.userRefOpacity=1}if(this.options.userRefOpacity<0){this.options.userRefOpacity=0}this.cX=this.screenSize.x/2;this.cY=this.screenSize.y/2;this.dX=this.options.userWidth;this.rX=this.dX/2;this.dY=this.options.userHeight*this.icons.length;this.rY=this.dY/2;this.magicwheel.setStyles({top:this.cY-this.rY,left:this.cX-this.rX-this.options.userIconWidth/2,width:this.dX+this.options.userIconWidth,height:this.dY+this.options.userIconWidth})},run:function(j){if(this.iconover&&!j){return}this.tip.setStyle("visibility","hidden");if(!this.iconover){if(this.speed>3){this.speed=3}else{if(this.speed<-3){this.speed=-3}}}for(i=0;i<=this.icons.length;i++){if(this.icons[i]){var g=i*(Math.PI*2)/this.icons.length;var d=(Math.sin(this.counter+g)*this.rX);var c=(Math.cos(this.counter+g)*this.rY);var a=(c+this.rY)/this.dY;var e=this.options.userIconWidth*a;if(e<this.options.userIconMinWidth){e=this.options.userIconMinWidth}var b=this.options.userIconOpacity*a;if(b<this.options.userIconMinOpacity){b=this.options.userIconMinOpacity}this.icons[i].setStyles({left:d+this.rX+this.options.userIconWidth/2-e/2,top:c+this.rY-Math.abs(this.speed*5),width:e,zIndex:(100*a),opacity:b});if(this.reflections[i]){var h=this.icons[i].getSize();this.reflections[i].setStyles({left:d+this.rX+this.options.userIconWidth/2-e/2,top:c+this.rY+h.y+Math.abs(this.speed*5),width:e,height:h.y,zIndex:(100*a),opacity:b*this.options.userRefOpacity-Math.abs(this.speed)*0.3+0.1})}}else{var h=this.icons[i-1].getSize()}}if(!this.iconover){if(this.speed.round(1)==0.1){this.speed=0.1}else{if(this.speed>0.1){this.speed=this.speed-0.1}else{if(this.speed<0.1){this.speed=this.speed+0.1}}}this.counter=this.counter+(this.options.userSpeed*this.speed)}}});