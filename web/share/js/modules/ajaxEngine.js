var ajaxEngine=new Class({Implements:[Events,Options],options:{linksrc:false,loadFrom:false,loadingImg:false,defaultIndex:0},running:false,initialize:function(b,a){this.setOptions(a);this.targetElement=$(b);if(!this.options.loadFrom){this.options.loadFrom=b}this.initLinks();if(Browser.Engine.trident){this.historyAnchor=new Element("a",{id:"historyAnchor",name:window.location.hash.replace(/\x23/,""),styles:{display:"none",position:"absolute"}});this.historyAnchor.inject($(document.body),"top")}if(!this.options.loadingImg){this.loadingHTML="<h2>Loading...</h2>"}else{this.loadingHTML="<img src='"+this.options.loadingImg+"' />"}var c=this;this.contentReq=new Request.HTML({evalScripts:false,method:"get",onRequest:function(){c.running=true;c.fireEvent("start")},onSuccess:function(e,d){d.each(function(g){try{if(g.id==c.options.loadFrom){c.fireEvent("complete",g)}}catch(f){}});c.running=false},onFailure:function(d){c.running=false;c.fireEvent("failure",d)}});this.addEvents({start:function(){this.targetElement.set("html",this.loadingHTML)},complete:function(d){this.targetElement.set("html",d.get("html"))}});this.initHash();this.fireEvent("initialize")},initLinks:function(){var a=this;if(!this.options.linksrc){this.linksrc=$$("a")}else{if($type(this.options.linksrc)=="array"){this.linksrc=$(this.options.linksrc[0]).getElements("a");this.options.linksrc.erase(this.options.linksrc[0]);this.options.linksrc.each(function(b){this.linksrc.extend($(b).getElements("a"))}.bind(this))}else{this.linksrc=$(this.options.linksrc).getElements("a")}}this.linksrc.each(function(c,b){c.store("linkID",b)});this.linksrc.addEvent("click",function(b){b.preventDefault();b.stopPropagation();a.updateLocHash(this.retrieve("linkID"));a.accessRequest(this.get("href"))})},initHash:function(){this.pageHash=window.location.hash;if(this.pageHash!=""){var a=this.getHashCode(this.pageHash);if(a!=false){this.updateLocHash(a.toInt());this.accessRequest(this.linksrc[a.toInt()].get("href"))}else{this.updateLocHash(this.linksrc[this.options.defaultIndex].retrieve("linkID"));this.accessRequest(this.linksrc[this.options.defaultIndex].get("href"))}}else{this.updateLocHash(this.linksrc[this.options.defaultIndex].retrieve("linkID"));this.accessRequest(this.linksrc[this.options.defaultIndex].get("href"))}this.hashHandler=this.hasher.periodical(300,this)},hasher:function(){if(Browser.Engine.trident){}if(this.pageHash!=window.location.hash){if(this.getHashCode(this.pageHash)!=this.getHashCode(window.location.hash)){this.pageHash=window.location.hash;var a=this.getHashCode(this.pageHash);if($chk(a)){this.accessRequest(this.linksrc[a.toInt()].get("href"))}}this.pageHash=window.location.hash}},getHashCode:function(c){c=c.replace(/\x23/,"");if(c.contains(this.targetElement.id)){var b=c.split("/");var a="";b.each(function(d){if(d.contains(this.targetElement.id)){a=d.toString()}}.bind(this));return a.replace(this.targetElement.id,"")}else{return false}},updateLocHash:function(c){var b=window.location.hash;if(b.contains(this.targetElement.id)){while(b.search(/\x23/,"")>-1){b=b.replace(/\x23/,"")}var a=b.split("/");a.each(function(d){if(d.contains(this.targetElement.id)){b=b.replace(d,this.targetElement.id+c)}}.bind(this))}else{if(!$chk(b)){b=this.targetElement.id+c}else{b+="/"+this.targetElement.id+c}}if(Browser.Engine.trident){this.historyAnchor.set("name",b);this.historyAnchor.set("id",b);this.pageHash=b;document.location="#"+b}else{window.location.hash=this.pageHash=b}},accessRequest:function(a){this.contentReq.cancel();this.contentReq.options.url=a;this.contentReq.get()}});
